<!--
‚úÖ iOS-Optimized (Safari) + No Mouse Tilt (touch + optional motion only)
‚úÖ + Strawberry CSS Art overlay (tap button to show)
‚úÖ NOTE: This version keeps your unlock/reveal logic unchanged.

‚úÖ HOW TO SEND (WhatsApp) + OPEN (Offline)
1) Save this file as: iloveyou.html
2) Put these files in the SAME folder:
   - iloveyou.html
   - shgan.jpg  (or .png)  ‚Üê Shgan photo (optional, but recommended)
   - music.mp3  (optional)
3) Send them on WhatsApp as DOCUMENTS (not as image/video).
4) On her phone: download them, keep them in the same folder, then open iloveyou.html:
   - Android: tap HTML ‚Üí ‚ÄúOpen with‚Äù ‚Üí Chrome
   - iPhone: Save to Files ‚Üí tap HTML ‚Üí Share ‚Üí ‚ÄúOpen in Safari‚Äù

‚úçÔ∏è WHERE TO EDIT
Search for:  ======== EDIT HERE ========
- SHGAN_PHOTO: base64 data URL OR a local filename (same folder)
- PHOTO_FOCUS_X / PHOTO_FOCUS_Y: fixes crop (so her face shows, not just forehead)
- MY_ARABIC_MESSAGE: your Arabic message (RTL + line breaks + emojis)
- MUSIC_SOURCE: base64 data URL OR local filename (same folder)
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ff6fa5" />
  <title>For Shgan üíó</title>

  <style>
    :root{
      --bg0:#fff6fa;
      --bg1:#ffe7f0;
      --bg2:#ffeef6;

      --pink:#ff4f93;
      --rose:#ff74ab;
      --peach:#ffb3c7;
      --red:#ff2f68;

      --ink:#231a25;
      --muted:#6d5a67;

      --cardA: rgba(255,255,255,.82);
      --cardB: rgba(255,255,255,.62);

      /* Fonts (offline-safe, iOS-friendly) */
      --ui-font: ui-sans-serif, -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Segoe UI", Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      --arabic-font: "Geeza Pro", "SF Arabic", "Noto Naskh Arabic", "Amiri", "Tahoma", "Arial", system-ui, sans-serif;

      --radius: 28px;

      /* Photo crop focus (percent) */
      --photo-x: 50%;
      --photo-y: 92%;

      /* 3D tilt variables (set by JS) */
      --rx: 0deg;
      --ry: 0deg;
      --tz: 0px;

      /* Dynamic shadow offsets (set by JS) */
      --sx: 0px;
      --sy: 18px;
      --sblur: 46px;

      /* Light sweep position (set by JS) */
      --lx: 50%;
      --ly: 30%;

      /* Depth knobs */
      --persp: 950px;
      --floatY: 0px; /* subtle float */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--ink);
      overflow-x:hidden; 
      font-family: var(--ui-font);
      background:
        radial-gradient(1200px 900px at 20% 0%, #ffffff 0%, #fff1f7 35%, #ffe4ef 65%, #ffeaf3 100%),
        radial-gradient(800px 600px at 85% 25%, rgba(255, 105, 165, 0.28), transparent 65%),
        radial-gradient(900px 700px at 50% 100%, rgba(255, 79, 147, 0.22), transparent 70%),
        linear-gradient(180deg, #fff6fa 0%, #ffeef6 100%);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Premium subtle grain */
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.18;
      mix-blend-mode: soft-light;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='260'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='260' height='260' filter='url(%23n)' opacity='.16'/%3E%3C/svg%3E");
    }

    /* Romantic soft vignette + animated aurora wash */
    body::after{
      content:"";
      position:fixed; inset:-20%;
      pointer-events:none;
      z-index:-2;
      background:
        radial-gradient(900px 700px at 50% 15%, rgba(255,255,255,.55), rgba(255,255,255,0) 60%),
        radial-gradient(900px 700px at 12% 70%, rgba(255,79,147,.16), rgba(255,79,147,0) 62%),
        radial-gradient(900px 700px at 88% 78%, rgba(255,179,199,.18), rgba(255,179,199,0) 65%),
        radial-gradient(1200px 900px at 50% 110%, rgba(35,26,37,.10), rgba(35,26,37,0) 55%);
      opacity: .85;
      animation: auroraFloat 10s ease-in-out infinite alternate;
    }
    @keyframes auroraFloat{
      0%{ transform: translate3d(-1.5%, -1%, 0) scale(1.02); }
      100%{ transform: translate3d(1.5%, 1%, 0) scale(1.06); }
    }

    /* Fixed canvases for depth particles */
    #bgCanvas, #burstCanvas{
      position:fixed; inset:0;
      width:100%; height:100%;
      pointer-events:none;
    }
    #bgCanvas{ z-index:-3; }
    /* ‚úÖ show constellation ABOVE the card (only during effect) */
    body.constellationOn #bgCanvas{
      z-index: 45;               /* ŸÅŸàŸÇ ÿßŸÑŸÉÿ±ÿ™ */
      mix-blend-mode: screen;    /* ÿßŸÜÿØŸÖÿßÿ¨ ÿ≠ŸÑŸà */
      opacity: .98;              /* Ÿàÿßÿ∂ÿ≠ */
    }
    #burstCanvas{ z-index:50; display:none; }
    #burstCanvas.show{ display:block; }

    /* 3D scene wrapper */
    .scene{
      min-height:100%;
      display:grid;
      place-items:center;
      padding: calc(24px + env(safe-area-inset-top)) calc(16px + env(safe-area-inset-right)) calc(44px + env(safe-area-inset-bottom)) calc(16px + env(safe-area-inset-left));
      perspective: var(--persp);
      perspective-origin: 50% 35%;
      position:relative;
    }

    /* Layered glow blobs (parallax driven by JS) */
    .blob{
      position:fixed;
      width:520px; height:520px;
      border-radius: 999px;
      filter: blur(10px);
      opacity:.75;
      pointer-events:none;
      z-index:-4;
      transform: translate3d(var(--bx,0px), var(--by,0px), 0);
    }
    .blob.b1{
      left:-180px; top:-220px;
      background: radial-gradient(circle at 30% 30%, rgba(255,79,147,.22), rgba(255,200,220,.18), transparent 72%);
      animation: blobDrift 12s ease-in-out infinite alternate;
    }
    .blob.b2{
      right:-220px; bottom:-240px; left:auto; top:auto;
      background: radial-gradient(circle at 30% 30%, rgba(255,122,169,.20), rgba(255,210,225,.16), transparent 72%);
      animation: blobDrift 14s ease-in-out infinite alternate;
      animation-delay: -2s;
    }
    @keyframes blobDrift{
      0%{ transform: translate3d(calc(var(--bx,0px) + 0px), calc(var(--by,0px) + 0px), 0) scale(1); }
      100%{ transform: translate3d(calc(var(--bx,0px) + 26px), calc(var(--by,0px) + 34px), 0) scale(1.06); }
    }

    /* Floating 3D card */
    .card{
      width:min(590px, 100%);
      border-radius: var(--radius);
      position:relative;
      transform-style: preserve-3d;
      transform:
        translate3d(0, var(--floatY), 0)
        rotateX(var(--rx))
        rotateY(var(--ry))
        translateZ(var(--tz));
      transition: filter .35s ease;
      isolation:isolate;
    }

    /* Card body */
    .cardInner{
      border-radius: inherit;
      overflow:hidden;
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border: 1px solid rgba(255,255,255,.62);
      box-shadow:
        0 var(--sy) var(--sblur) rgba(255, 79, 147, .16),
        0 12px 34px rgba(35, 26, 37, .10);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      position:relative;
      transform-style: preserve-3d;
      padding: 22px 18px 18px;
    }

    @supports not ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) {
      .cardInner{ background: rgba(255,255,255,.92); }
      .unlock, .reveal, .msg{ background: rgba(255,255,255,.90); }
    }

    /* Premium gradient border */
    .cardInner::before{
      content:"";
      position:absolute; inset:0;
      padding:1px;
      border-radius: inherit;
      background: linear-gradient(135deg,
        rgba(255,79,147,.42),
        rgba(255,255,255,.56),
        rgba(255,179,199,.38)
      );
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;
      pointer-events:none;
      opacity:.78;
      z-index:1;
    }

    /* Light sweep reflection */
    .lightSweep{
      position:absolute; inset:-20%;
      background:
        radial-gradient(260px 220px at var(--lx) var(--ly),
          rgba(255,255,255,.55),
          rgba(255,255,255,.20),
          rgba(255,255,255,0) 70%);
      transform: translateZ(40px);
      mix-blend-mode: soft-light;
      opacity:.60;
      pointer-events:none;
      z-index:2;
      filter: blur(1px);
    }

    /* Specular diagonal streak */
    .streak{
      position:absolute;
      inset:-60% -40%;
      background: linear-gradient(115deg,
        rgba(255,255,255,0) 40%,
        rgba(255,255,255,.28) 50%,
        rgba(255,255,255,0) 60%);
      transform: translateZ(46px) rotate(6deg);
      opacity:.35;
      pointer-events:none;
      z-index:2;
      animation: streakMove 4.2s ease-in-out infinite;
    }
    @keyframes streakMove{
      0%,100%{ transform: translateZ(46px) translateX(-18%) rotate(6deg); }
      50%{ transform: translateZ(46px) translateX(18%) rotate(6deg); }
    }

    /* Decorative top bloom */
    .topBloom{
      position:absolute; inset:-2px -2px auto -2px;
      height:130px;
      background:
        radial-gradient(420px 160px at 40% 0%, rgba(255,79,147,.26), transparent 70%),
        radial-gradient(460px 170px at 84% 30%, rgba(255,179,199,.28), transparent 70%);
      transform: translateZ(10px);
      z-index:0;
      opacity:.95;
      pointer-events:none;
    }

    /* Content (depth layers) */
    .content{
      position:relative;
      z-index:3;
      transform: translateZ(20px);
    }

    .titleLine{
      text-align:center;
      font-size: 12px;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: rgba(109, 90, 103, .86);
      margin: 2px 0 12px;
      user-select:none;
    }

    h1{
      margin:0;
      text-align:center;
      font-size: clamp(28px, 7vw, 40px);
      letter-spacing: -0.03em;
      line-height: 1.12;
    }
    .nameGlow{
      color: var(--pink);
      text-shadow: 0 0 24px rgba(255,79,147,.35);
    }

    .subtitle{
      margin: 10px auto 18px;
      text-align:center;
      color: rgba(109, 90, 103, .92);
      font-size: 15px;
      line-height: 1.6;
      max-width: 46ch;
    }

    /* Heart stage (3D-ish) */
    .heartStage{
      margin: 6px auto 14px;
      display:grid;
      place-items:center;
      transform-style: preserve-3d;
      position:relative;
    }

    .heartWrap{
      width: min(290px, 74vw);
      aspect-ratio: 1/1;
      display:grid;
      place-items:center;
      position:relative;
      transform: translateZ(28px);
      filter: drop-shadow(0 18px 28px rgba(255,79,147,.16));
    }

    .heartShadow{
      position:absolute;
      width: 62%;
      height: 14%;
      bottom: 14%;
      left: 19%;
      border-radius: 999px;
      background: radial-gradient(circle at 50% 50%,
        rgba(35,26,37,.24),
        rgba(35,26,37,0) 70%);
      filter: blur(10px);
      transform: translateZ(-10px);
      opacity:.65;
    }

    svg{ overflow: visible; }

    .heartPath{
      fill: transparent;
      stroke: rgba(255,79,147,.96);
      stroke-width: 8;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 1100;
      stroke-dashoffset: 1100;
      filter: drop-shadow(0 0 10px rgba(255,79,147,.20));
      animation: draw 2.5s ease forwards;
    }
    @keyframes draw{ to{ stroke-dashoffset: 0; } }

    .heartFill{
      fill: url(#heartG);
      opacity: 0;
      transform-origin:center;
      animation: fillIn .85s ease forwards;
      animation-delay: 2.05s;
    }
    @keyframes fillIn{ to{ opacity: .94; } }

    .heart3D{
      transform-origin:center;
      animation: pulse 1.35s ease-in-out infinite;
      animation-delay: 2.55s;
      filter: drop-shadow(0 16px 26px rgba(255,79,147,.18));
    }
    @keyframes pulse{
      0%,100% { transform: translateZ(0) scale(1); }
      20% { transform: translateZ(6px) scale(1.05); }
      40% { transform: translateZ(1px) scale(0.99); }
      60% { transform: translateZ(7px) scale(1.06); }
      80% { transform: translateZ(2px) scale(1.00); }
    }

    /* Fake inner glow overlay */
    .innerGlow{
      position:absolute;
      inset: 18% 20% 26% 20%;
      border-radius: 40%;
      background: radial-gradient(circle at 30% 30%,
        rgba(255,255,255,.65),
        rgba(255,255,255,.08) 55%,
        rgba(255,255,255,0) 70%);
      transform: translateZ(26px) rotate(-8deg);
      pointer-events:none;
      mix-blend-mode: screen;
      opacity:.55;
      filter: blur(2px);
    }

    /* Floating micro particles around heart */
    .micro{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:.9;
      transform: translateZ(18px);
    }
    .micro i{
      position:absolute;
      width: 8px; height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(255,255,255,.98), rgba(255,255,255,0) 72%);
      box-shadow: 0 0 18px rgba(255,255,255,.70);
      opacity:0;
      animation: tw 2.8s ease-in-out infinite;
    }
    .micro i:nth-child(1){ left: 14%; top: 22%; animation-delay:.2s; }
    .micro i:nth-child(2){ left: 78%; top: 20%; animation-delay:1.0s; }
    .micro i:nth-child(3){ left: 16%; top: 74%; animation-delay:1.6s; }
    .micro i:nth-child(4){ left: 80%; top: 68%; animation-delay:.7s; }
    .micro i:nth-child(5){ left: 50%; top: 8%;  animation-delay:2.0s; width:10px; height:10px; }
    @keyframes tw{
      0%{ transform: scale(.6) translateY(2px); opacity:0; }
      22%{ opacity:.85; }
      45%{ transform: scale(1.05) translateY(-2px); opacity:1; }
      75%{ opacity:.25; }
      100%{ transform: scale(.6) translateY(2px); opacity:0; }
    }

    /* Unlock module */
    .unlock{
      margin-top: 10px;
      border-radius: 20px;
      background: rgba(255,255,255,.62);
      border: 1px solid rgba(255,255,255,.68);
      box-shadow: 0 12px 28px rgba(255,79,147,.10);
      padding: 14px 14px 12px;
      transform: translateZ(22px);
    }

    .label{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      font-size: 13.6px;
      color: rgba(35,26,37,.88);
      margin-bottom: 10px;
      user-select:none;
      text-align:center;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:stretch;
      justify-content:center;
    }

    input{
      appearance:none;
      -webkit-appearance:none;
      width: 100%;
      flex: 1 1 auto;
      max-width: 360px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255, 122, 169,.36);
      outline: none;
      background: rgba(255,255,255,.88);
      color: var(--ink);
      font-size: 15.5px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.60);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    input:focus{
      border-color: rgba(255, 79, 147,.58);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.70), 0 0 0 7px rgba(255, 122, 169,.18);
    }

    .btn{
      flex: 0 0 auto;
      padding: 12px 14px;
      border-radius: 16px;
      border: 0;
      background: linear-gradient(180deg, rgba(255,105,165,1), rgba(255,47,104,1));
      color:#fff;
      font-weight: 800;
      font-size: 14px;
      letter-spacing: .02em;
      box-shadow: 0 16px 28px rgba(255,79,147,.22);
      cursor:pointer;
      transform: translateZ(0);
      transition: transform .16s ease, box-shadow .16s ease, filter .16s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{
      transform: translateY(1px) scale(.99);
      filter: brightness(.98);
      box-shadow: 0 12px 20px rgba(255, 79, 147,.18);
    }

    .btn.secondary{
      background: rgba(255,255,255,.94);
      color: rgba(35, 26, 37,.92);
      border: 1px solid rgba(255, 122, 169,.30);
      box-shadow: 0 12px 22px rgba(35, 26, 37,.08);
      font-weight: 800;
    }

    .hint{
      margin: 10px 2px 0;
      text-align:center;
      font-size: 13px;
      color: rgba(109, 90, 103,.95);
      min-height: 18px;
      user-select:none;
    }

    .shake{ animation: shake .38s ease; }
    @keyframes shake{
      0%,100% { transform: translateX(0); }
      20% { transform: translateX(-7px); }
      40% { transform: translateX(7px); }
      60% { transform: translateX(-5px); }
      80% { transform: translateX(5px); }
    }

    /* Reveal (cinematic) */
    .reveal{
      margin-top: 16px;
      border-radius: 22px;
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(255,255,255,.72);
      box-shadow: 0 18px 44px rgba(35, 26, 37,.10);
      padding: 16px 14px 14px;
      display:none;
      opacity:0;
      transform: translateZ(26px) translateY(16px);
      filter: blur(10px) saturate(1.06);
    }
    .reveal.show{
      display:block;
      animation: revealIn .85s cubic-bezier(.2,.9,.12,1) forwards;
    }
    @keyframes revealIn{
      0%{ opacity:0; transform: translateZ(26px) translateY(18px); filter: blur(12px); }
      100%{ opacity:1; transform: translateZ(26px) translateY(0); filter: blur(0px); }
    }

    .unlockedBadge{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      margin: 4px auto 12px;
      user-select:none;
      transform: translateZ(28px);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255, 79, 147,.12);
      border: 1px solid rgba(255, 79, 147,.22);
      color: rgba(35, 26, 37,.92);
      font-weight: 900;
      font-size: 13.5px;
    }
    .miniPop{
      width: 12px; height: 12px;
      border-radius: 999px;
      background: linear-gradient(180deg, #fff, rgba(255,255,255,.6));
      box-shadow: 0 0 0 6px rgba(255,79,147,.18);
      animation: pop 1.2s ease-in-out infinite;
    }
    @keyframes pop{
      0%,100%{ transform: scale(1); opacity:.85; }
      50%{ transform: scale(1.25); opacity:1; }
    }

    .photo{
      width: 100%;
      max-width: 360px;
      margin: 18px auto 12px;
      border-radius: 20px;
      overflow:hidden;
      position:relative;
      box-shadow: 0 20px 44px rgba(255, 79, 147,.16);
      border: 1px solid rgba(255,255,255,.72);
      background:
        radial-gradient(140px 140px at 30% 30%, rgba(255,79,147,.16), transparent 60%),
        rgba(255,255,255,.64);
      aspect-ratio: 4 / 5;
      display:grid;
      place-items:center;
      transform: translateZ(26px);
      background-size: cover;
      background-position: var(--photo-x) var(--photo-y);
    }
    .photo img{ display:none !important; }
    .photo .ph{
      padding: 22px 18px;
      text-align:center;
      color: rgba(109, 90, 103,.92);
      font-size: 13.5px;
      line-height: 1.5;
    }

    /* One-time subtle sparkle around the photo (plays once on reveal) */
    .photo[data-has-photo="1"]::before,
    .photo[data-has-photo="1"]::after{
      content:"";
      position:absolute;
      inset: 6px;
      border-radius: 18px;
      pointer-events:none;
      opacity:0;
      z-index: 4;
      mix-blend-mode: screen;
    }

    .photo[data-has-photo="1"]::before{
      background:
        radial-gradient(6px 6px at 14% 18%, rgba(255,255,255,.95), rgba(255,255,255,0) 70%),
        radial-gradient(5px 5px at 82% 24%, rgba(255,255,255,.92), rgba(255,255,255,0) 70%),
        radial-gradient(7px 7px at 22% 86%, rgba(255,255,255,.90), rgba(255,255,255,0) 70%),
        radial-gradient(6px 6px at 88% 78%, rgba(255,255,255,.90), rgba(255,255,255,0) 70%),
        radial-gradient(10px 10px at 52% 6%, rgba(255,255,255,.80), rgba(255,255,255,0) 70%);
      filter: blur(.2px);
    }

    .photo[data-has-photo="1"]::after{
      background: radial-gradient(closest-side, rgba(255,255,255,.30), rgba(255,255,255,0) 70%);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.55),
        0 0 18px rgba(255,79,147,.18),
        0 0 28px rgba(255,179,199,.14);
      filter: blur(1px);
    }

    @keyframes photoSparkOnce{
      0%   { opacity:0; transform: scale(.985); }
      18%  { opacity:.95; }
      55%  { opacity:.40; }
      100% { opacity:0; transform: scale(1.03); }
    }

    .reveal.show .photo[data-has-photo="1"]::before,
    .reveal.show .photo[data-has-photo="1"]::after{
      animation: photoSparkOnce 1.05s ease-out 1 forwards;
    }

    .msg{
      max-width: 400px;
      margin: 0 auto 14px;
      border-radius: 18px;
      padding: 14px 14px 12px;
      background: rgba(255,255,255,.74);
      border: 1px solid rgba(255,255,255,.70);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.55);
      transform: translateZ(26px);
    }
    .arabic{
      direction: rtl;
      text-align: right;
      unicode-bidi: plaintext;
      white-space: pre-wrap;
      font-size: 16.5px;
      line-height: 1.85;
      color: rgba(35, 26, 37,.96);
      font-family: var(--arabic-font);
    }

    /* Pro line-by-line reveal (RTL-safe) */
    .arabicLines{ display:block; }
    .arabicLine{
      display:block;
      opacity:0;
      transform: translateY(6px);
      filter: blur(3px);
      transition: opacity .55s ease, transform .55s ease, filter .55s ease;
      will-change: opacity, transform, filter;
      padding: 2px 0;
    }
    .arabicLine.show{
      opacity:1;
      transform: translateY(0);
      filter: blur(0);
    }

    .typingCursor{
      display:inline-block;
      width: 10px;
      height: 18px;
      vertical-align: -3px;
      margin-right: 6px;
      border-radius: 999px;
      background: rgba(255,79,147,.55);
      box-shadow: 0 0 14px rgba(255,79,147,.25);
      animation: blink 1s ease-in-out infinite;
    }
    @keyframes blink{
      0%,100%{ opacity:.25; }
      50%{ opacity:1; }
    }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:center;
      margin-top: 6px;
      transform: translateZ(26px);
    }

    .footerNote{
      margin-top: 14px;
      text-align:center;
      color: rgba(109, 90, 103,.78);
      font-size: 12.5px;
      line-height: 1.6;
      user-select:none;
      transform: translateZ(18px);
    }

    @media (max-width: 360px){
      .row{ flex-direction:column; }
      .btn{ width:100%; }
      input{ max-width:none; }
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; }
      #bgCanvas{ display:none; }
    }

    /* ================= Envelope Unwrap + Secret Toast ================= */
    .envelopeWrap{
      max-width: 420px;
      margin: 14px auto 6px;
      transform: translateZ(26px);
      display:grid;
      place-items:center;
    }
    .envelope{
      width: min(340px, 92%);
      height: 170px;
      position: relative;
      border-radius: 18px;
      perspective: 900px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      filter: drop-shadow(0 18px 34px rgba(255,79,147,.16));
    }
    .envBody{
      position:absolute; inset:0;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.72));
      border: 1px solid rgba(255,255,255,.75);
      overflow:hidden;
    }
    .envBody::before{
      content:"";
      position:absolute; inset:-60% -40% auto -40%;
      height: 220px;
      background: linear-gradient(115deg,
        rgba(255,255,255,0) 40%,
        rgba(255,255,255,.28) 50%,
        rgba(255,255,255,0) 60%);
      opacity:.35;
      transform: translateX(-10%);
      animation: envSheen 4.6s ease-in-out infinite;
    }
    @keyframes envSheen{ 0%,100%{ transform: translateX(-18%);} 50%{ transform: translateX(18%);} }

    .envPocket{
      position:absolute; inset:0;
      border-radius: 18px;
      background:
        linear-gradient(135deg, rgba(255,79,147,.18), rgba(255,255,255,0) 55%),
        radial-gradient(160px 120px at 30% 20%, rgba(255,179,199,.18), rgba(255,179,199,0) 70%);
    }
    .envPocket::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:0;
      height:0;
      border-left:170px solid transparent;
      border-right:170px solid transparent;
      border-top:110px solid rgba(255,255,255,.78);
      opacity:.95;
      filter: drop-shadow(0 -1px 0 rgba(255,122,169,.20));
      margin:auto;
    }

    .envFlap{
      position:absolute;
      left:0; right:0; top:0;
      width:0; height:0;
      border-left:170px solid transparent;
      border-right:170px solid transparent;
      border-bottom:115px solid rgba(255,255,255,.90);
      margin:auto;
      transform-origin: 50% 0%;
      transform: rotateX(0deg);
      transition: transform .62s cubic-bezier(.2,.9,.12,1);
      filter: drop-shadow(0 6px 10px rgba(35,26,37,.08));
    }

    .envBadge{
      position:absolute;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border-radius:999px;
      background: rgba(255,79,147,.12);
      border: 1px solid rgba(255,79,147,.22);
      color: rgba(35,26,37,.92);
      font-weight:900;
      font-size:13.5px;
      box-shadow: 0 14px 22px rgba(255,79,147,.12);
    }

    .envCard{
      position:absolute;
      left:14px; right:14px;
      bottom:14px;
      height:120px;
      border-radius:16px;
      background:
        radial-gradient(180px 120px at 30% 20%, rgba(255,79,147,.14), rgba(255,79,147,0) 70%),
        linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.78));
      border: 1px solid rgba(255,255,255,.72);
      transform: translateY(46px);
      transition: transform .70s cubic-bezier(.2,.9,.12,1), opacity .45s ease;
      opacity:0;
      box-shadow: 0 18px 32px rgba(35,26,37,.10);
      overflow:hidden;
    }
    .envCard::after{
      content:"";
      position:absolute; inset:-40% -30% auto -30%;
      height:180px;
      background: radial-gradient(220px 120px at 50% 40%, rgba(255,255,255,.75), rgba(255,255,255,0) 70%);
      opacity:.45;
    }

    .envelope.open .envFlap{ transform: rotateX(-150deg); }
    .envelope.open .envCard{ transform: translateY(-6px); opacity:1; }

    .revealContent{
      display:none;
      opacity:0;
      transform: translateY(10px);
      filter: blur(6px);
      transition: opacity .55s ease, transform .55s ease, filter .55s ease;
    }
    .revealContent.show{
      display:block;
      opacity:1;
      transform: translateY(0);
      filter: blur(0);
    }

    .toast{
      position: fixed;
      left: 50%;
      top: calc(14px + env(safe-area-inset-top));
      transform: translateX(-50%);
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(255,255,255,.72);
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: 0 18px 40px rgba(35,26,37,.12);
      color: rgba(35,26,37,.95);
      font-weight: 900;
      font-size: 13.5px;
      z-index: 60;
      opacity:0;
      pointer-events:none;
    }
    .toast.show{ animation: toastInOut 2.2s ease forwards; }
    @keyframes toastInOut{
      0%{ opacity:0; transform: translateX(-50%) translateY(-8px); filter: blur(6px); }
      18%{ opacity:1; transform: translateX(-50%) translateY(0); filter: blur(0); }
      80%{ opacity:1; }
      100%{ opacity:0; transform: translateX(-50%) translateY(-10px); }
    }

    /* BERRY FEATURE START */
    .berryOverlay{
      position: fixed;
      inset: 0;
      z-index: 65;
      display: none;
      place-items: center;
      padding: calc(18px + env(safe-area-inset-top)) calc(16px + env(safe-area-inset-right)) calc(22px + env(safe-area-inset-bottom)) calc(16px + env(safe-area-inset-left));
      background: rgba(35,26,37,.24);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      opacity: 0;
      transition: opacity .22s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .berryOverlay.show{ display:grid; }
    .berryOverlay.on{ opacity: 1; }

    @supports not ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) {
      .berryOverlay{ background: rgba(35,26,37,.34); }
    }

    .berrySheet{
      width: min(420px, 92vw);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.72);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.72));
      box-shadow: 0 22px 58px rgba(35,26,37,.18);
      position: relative;
      overflow: hidden;
      transform: translateY(12px) scale(.96);
      opacity: 0;
      transition: transform .36s cubic-bezier(.2,.9,.12,1), opacity .24s ease;
      will-change: transform, opacity;
    }

    .berryOverlay.on .berrySheet{
      opacity: 1;
      transform: translateY(0) scale(1);
      animation: berryPop .62s cubic-bezier(.2,.9,.12,1) both;
    }

    @keyframes berryPop{
      0%{ transform: translateY(14px) scale(.92); }
      55%{ transform: translateY(-2px) scale(1.03); }
      75%{ transform: translateY(1px) scale(.995); }
      100%{ transform: translateY(0) scale(1); }
    }

    .berrySheet::before{
      content:"";
      position:absolute;
      inset:-40% -35% auto -35%;
      height: 220px;
      background:
        radial-gradient(240px 160px at 50% 40%, rgba(255,255,255,.75), rgba(255,255,255,0) 70%),
        radial-gradient(260px 200px at 20% 10%, rgba(255,79,147,.18), rgba(255,79,147,0) 65%),
        radial-gradient(260px 200px at 85% 30%, rgba(255,179,199,.18), rgba(255,179,199,0) 65%);
      opacity:.7;
      pointer-events:none;
    }

    .berryClose{
      position:absolute;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(255,122,169,.26);
      background: rgba(255,255,255,.92);
      color: rgba(35,26,37,.92);
      font-weight: 900;
      font-size: 18px;
      box-shadow: 0 12px 22px rgba(35,26,37,.10);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .berryClose:active{ transform: scale(.98); }

    .berryStage{
      padding: 54px 18px 10px;
      display: grid;
      place-items: center;
    }

    .berryText{
      text-align:center;
      padding: 8px 16px 16px;
      color: rgba(109, 90, 103,.92);
      font-size: 13.5px;
      font-weight: 800;
      user-select: none;
    }

    .strawberry{
      width: 170px;
      height: 190px;
      position: relative;
      filter: drop-shadow(0 18px 26px rgba(255,79,147,.18));
    }

    .berryShadow{
      width: 150px;
      height: 26px;
      border-radius: 999px;
      background: radial-gradient(circle at 50% 50%, rgba(35,26,37,.22), rgba(35,26,37,0) 70%);
      filter: blur(10px);
      transform: translateY(76px);
      opacity: .72;
    }

    .berryBody{
      position:absolute;
      left: 50%;
      top: 44px;
      width: 140px;
      height: 145px;
      transform: translateX(-50%);
      border-radius: 55% 55% 66% 66% / 52% 52% 82% 82%;
      background:
        radial-gradient(70px 60px at 32% 28%, rgba(255,255,255,.32), rgba(255,255,255,0) 62%),
        radial-gradient(120px 110px at 35% 40%, rgba(255,79,147,.18), rgba(255,79,147,0) 70%),
        linear-gradient(180deg, rgba(255,120,165,1) 0%, rgba(255,79,147,1) 42%, rgba(255,47,104,1) 100%);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.48),
        inset 0 -18px 26px rgba(35,26,37,.16);
      overflow: hidden;
    }

    .berryBody::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(8px 10px at 18% 40%, rgba(255,255,255,.10), rgba(255,255,255,0) 70%),
        radial-gradient(10px 12px at 78% 62%, rgba(255,255,255,.08), rgba(255,255,255,0) 70%),
        radial-gradient(12px 14px at 44% 76%, rgba(255,255,255,.06), rgba(255,255,255,0) 70%);
      opacity:.85;
      mix-blend-mode: soft-light;
      pointer-events:none;
    }

    .berryHighlight{
      position:absolute;
      left: 50%;
      top: 62px;
      width: 78px;
      height: 108px;
      transform: translateX(-78px) rotate(-10deg);
      border-radius: 999px;
      background: radial-gradient(closest-side, rgba(255,255,255,.46), rgba(255,255,255,0) 72%);
      filter: blur(.2px);
      opacity: .9;
      pointer-events:none;
    }

    .berrySeeds{
      position:absolute;
      left: 50%;
      top: 44px;
      width: 140px;
      height: 145px;
      transform: translateX(-50%);
      border-radius: 55% 55% 66% 66% / 52% 52% 82% 82%;
      background:
        repeating-radial-gradient(circle at 18px 18px,
          rgba(255,242,198,.95) 0 2px,
          rgba(255,242,198,.95) 2px 3px,
          rgba(35,26,37,.12) 3px 4px,
          rgba(255,255,255,0) 4px 16px);
      opacity: .92;
      pointer-events:none;
      mix-blend-mode: overlay;
    }

    .berryLeaves{
      position:absolute;
      left: 50%;
      top: 26px;
      width: 160px;
      height: 90px;
      transform: translateX(-50%);
      pointer-events:none;
    }
    .berryLeaves::before,
    .berryLeaves::after{
      content:"";
      position:absolute;
      left: 50%;
      top: 14px;
      width: 150px;
      height: 76px;
      transform: translateX(-50%);
      background:
        radial-gradient(80px 60px at 50% 30%, rgba(255,255,255,.34), rgba(255,255,255,0) 65%),
        linear-gradient(180deg, rgba(140, 230, 170, 1) 0%, rgba(54, 196, 120, 1) 58%, rgba(24, 160, 94, 1) 100%);
      clip-path: polygon(
        50% 0%,
        62% 18%, 78% 10%,
        72% 32%, 92% 34%,
        76% 48%, 92% 62%,
        66% 58%, 58% 78%,
        50% 60%,
        42% 78%, 34% 58%,
        8% 62%, 24% 48%,
        8% 34%, 28% 32%,
        22% 10%, 38% 18%
      );
      border-radius: 22px;
      filter: drop-shadow(0 10px 16px rgba(35,26,37,.10));
    }
    .berryLeaves::after{
      opacity: .35;
      filter: blur(1px);
      transform: translateX(-50%) translateY(2px) scale(.98);
      mix-blend-mode: soft-light;
    }

    .berryStem{
      position:absolute;
      left: 50%;
      top: 8px;
      width: 16px;
      height: 34px;
      transform: translateX(-50%) rotate(-6deg);
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(120, 210, 150, 1), rgba(40, 170, 100, 1));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.30);
      filter: drop-shadow(0 10px 14px rgba(35,26,37,.10));
    }

    .strawberry::after{
      content:"";
      position:absolute;
      left: 50%;
      top: 54px;
      width: 150px;
      height: 150px;
      transform: translateX(-50%);
      border-radius: 999px;
      box-shadow:
        0 0 0 1px rgba(255,255,255,.55),
        0 0 22px rgba(255,79,147,.22),
        0 0 40px rgba(255,179,199,.18);
      opacity: 0;
      animation: berryGlow 1.05s ease forwards;
      pointer-events:none;
    }
    .berryOverlay.on .strawberry::after{ opacity: 1; }

    @keyframes berryGlow{
      0%{ transform: translateX(-50%) scale(.95); opacity:0; }
      18%{ opacity:1; }
      70%{ opacity:.42; }
      100%{ transform: translateX(-50%) scale(1.04); opacity:0; }
    }
    /* BERRY FEATURE END */
  </style>
</head>

<body>
  <canvas id="bgCanvas" aria-hidden="true"></canvas>
  <canvas id="burstCanvas" aria-hidden="true"></canvas>
  <div class="blob b1" aria-hidden="true"></div>
  <div class="blob b2" aria-hidden="true"></div>

  <main class="scene">
    <section class="card" id="card" aria-label="Birthday surprise for Shgan">
      <div class="cardInner" id="cardInner">
        <div class="topBloom" aria-hidden="true"></div>
        <div class="lightSweep" aria-hidden="true"></div>
        <div class="streak" aria-hidden="true"></div>

        <div class="content">
          <p class="titleLine" id="titleLine">A tiny surprise made with love</p>

          <h1>
            For <span class="nameGlow">Shgan</span> üíó
          </h1>

          <p class="subtitle" id="subtitle">
            ‚ú® ÿßŸÉÿ™ÿ®Ÿä ÿ™ÿßÿ±ŸäÿÆŸÉ ÿßŸÑŸÖŸÖŸäÿ≤ ŸÑÿ™ÿ¥ŸàŸÅŸä ŸáÿØŸäÿ™ŸÉ ÿßŸÑÿ≠ŸÑŸàÿ© ÿ≤ŸäŸëŸÉ ‚ú®
          </p>

          <div class="heartStage" aria-hidden="true">
            <div class="heartWrap">
              <div class="heartShadow"></div>

              <svg class="heart3D" width="290" height="270" viewBox="0 0 280 260" role="img" aria-label="Heart">
                <defs>
                  <linearGradient id="heartG" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0%" stop-color="#ff86b6" stop-opacity="0.98"/>
                    <stop offset="55%" stop-color="#ff4f93" stop-opacity="0.88"/>
                    <stop offset="100%" stop-color="#ff2f68" stop-opacity="0.82"/>
                  </linearGradient>
                </defs>

                <path class="heartFill" d="M140 235
                  C 65 190, 25 145, 25 95
                  C 25 60, 48 38, 78 38
                  C 103 38, 125 52, 140 72
                  C 155 52, 177 38, 202 38
                  C 232 38, 255 60, 255 95
                  C 255 145, 215 190, 140 235 Z"/>

                <path class="heartPath" d="M140 235
                  C 65 190, 25 145, 25 95
                  C 25 60, 48 38, 78 38
                  C 103 38, 125 52, 140 72
                  C 155 52, 177 38, 202 38
                  C 232 38, 255 60, 255 95
                  C 255 145, 215 190, 140 235 Z"/>
              </svg>

              <div class="innerGlow"></div>
              <div class="micro"><i></i><i></i><i></i><i></i><i></i></div>
            </div>
          </div>

          <div class="unlock" id="unlockBox">
            <div class="label">üéÅ Enter your birthday to open your surprise</div>

            <div class="row">
              <input id="dateInput" type="text" inputmode="numeric" pattern="[0-9/\.\\- ]*" enterkeyhint="done"
                     autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
                     placeholder=" The Special Date : " aria-label="Birthday input" />
              <button class="btn" id="unlockBtn" type="button">Unlock</button>
            </div>

            <div class="hint" id="hint"></div>

            <div class="footerNote" style="margin-top:10px;">
              Tip: type <b> special date </b> (it auto becomes with the xx/xx/xxxx ) üíû
            </div>
          </div>

          <div class="reveal" id="reveal">
            <div class="unlockedBadge">
              <span class="pill">Unlocked! ‚ú®</span>
              <span class="miniPop" aria-hidden="true"></span>
            </div>

            <div class="envelopeWrap" id="envelopeWrap">
              <div class="envelope" id="envelope" role="button" aria-label="Open envelope" tabindex="0">
                <div class="envBody">
                  <div class="envPocket"></div>
                  <div class="envCard" aria-hidden="true"></div>
                </div>
                <div class="envFlap" aria-hidden="true"></div>
                <div class="envBadge" id="envBadge">Tap to open üíå</div>
              </div>
            </div>

            <div class="revealContent" id="revealContent">
              <div class="photo" id="photoBox" aria-label="Photo of Shgan" data-has-photo="0">
                <div class="ph" id="photoPlaceholder">
                  <div style="font-size:22px; margin-bottom:6px;">üì∏üíó</div>
                  <div><b>Your photo goes here üíó</b></div>
                  <div style="opacity:.85; margin-top:6px;">(Add it in the EDIT HERE section.)</div>
                </div>
              </div>

              <div class="msg">
                <div class="arabic arabicLines" id="arabicMsg"></div>
              </div>

              <div class="actions">
                <button class="btn secondary" id="musicBtn" type="button">Play music üé∂</button>
                <button class="btn secondary" id="motionBtn" type="button">3D Motion ‚ú®</button>
                <button class="btn secondary" id="berryBtn" type="button">Strawberry üçì</button>
                <button class="btn secondary" id="saveBtn" type="button">Save this memory üíå</button>
              </div>

              <div class="footerNote" style="margin-top:12px;">
                 ÿµŸÜÿπ ÿ®ŸÉŸÑ ÿ≠ÿ® ŸàŸÜÿßÿ®ÿπ ŸÖŸÜ ÿßŸÑŸÇŸÑÿ® üå∏
              </div>
            </div>
          </div>

          <div class="footerNote" id="copyrightNote">
            ¬© 2026 Made with ‚ù§Ô∏è by Obai for Shgan
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- BERRY FEATURE START -->
  <div class="berryOverlay" id="berryOverlay" aria-hidden="true">
    <div class="berrySheet" role="dialog" aria-modal="true" aria-label="Strawberry surprise">
      <button class="berryClose" id="berryClose" type="button" aria-label="Close">‚úï</button>

      <div class="berryStage" aria-hidden="true">
        <div class="berryShadow"></div>
        <div class="strawberry" role="img" aria-label="Cute strawberry">
          <div class="berryBody"></div>
          <div class="berryHighlight"></div>
          <div class="berrySeeds"></div>
          <div class="berryLeaves"></div>
          <div class="berryStem"></div>
        </div>
      </div>

      <div class="berryText">Tap anywhere to close üíó</div>
    </div>
  </div>
  <!-- BERRY FEATURE END -->

  <script>
    /************************************************************
     * =============== EDIT HERE (Your Controls) =================
     ************************************************************/

    // (1) Title line (small text)
    const OPTIONAL_TITLE_LINE = "A tiny surprise made with love";

    // (2) Photo:
    // Option A: Base64 data URL
    // const SHGAN_PHOTO = "data:image/jpeg;base64,....";
    // Option B: Local file name (same folder as this HTML)
    const SHGAN_PHOTO = "shgonte.png"; // e.g. "shgonte.png"

    // ‚úÖ (3) PHOTO CROP FIX (IMPORTANT)
    // If you only see her forehead, increase PHOTO_FOCUS_Y (e.g. 88..95)
    // If the face is too low, reduce it (e.g. 70..85)
    // PHOTO_FOCUS_X moves left/right if needed.
    const PHOTO_FOCUS_X = 50; // 0..100
    const PHOTO_FOCUS_Y = 80; // 0..100  (try 92, 94, 96 if needed)

    // (4) Arabic message (RTL + line breaks preserved)
    const MY_ARABIC_MESSAGE = `
ÿ¥ÿ¨ŸÜ ÿ®ŸÑÿßŸÑ ÿ≤ŸÉŸä ÿ≥ÿπÿßÿØÿ© üíó

ÿßŸÑŸäŸàŸÖ ŸäŸàŸÖ ŸÖÿ¥ ÿπÿßÿØŸä‚Ä¶
ŸÅŸä ŸÖÿ´ŸÑ ŸáÿßŸÑŸäŸàŸÖÿå ŸÇÿ®ŸÑ 20 ÿ≥ŸÜÿ©ÿå ÿ•ÿ¨ÿ™ ÿπÿßŸÑÿØŸÜŸäÿß ÿ®ŸÜÿ™ ŸÇŸÖÿ± ‚ú®
ŸÑŸÅŸëÿ™ ÿßŸÑÿØŸÜŸäÿß ÿ®ŸáÿØŸàÿ¶Ÿáÿß Ÿàÿ∂ÿ≠ŸÉÿ™Ÿáÿßÿå Ÿàÿ®ÿπÿØ 18 ÿ≥ŸÜÿ© ŸàŸÜÿµ ŸàÿµŸÑÿ™ ÿπŸÜÿØŸä‚Ä¶ Ÿàÿµÿßÿ± ŸÑŸÑÿπÿßŸÑŸÖ ÿ∑ÿπŸÖ ÿ´ÿßŸÜŸä.

ÿßŸÑŸäŸàŸÖ ÿµÿ±ÿ™Ÿê 20 ÿ≥ŸÜÿ©ÿå ŸàÿßŸÑŸä ÿ¨ÿßŸä ÿ•ŸÜ ÿ¥ÿßÿ° ÿßŸÑŸÑŸá ÿ£ÿ≠ŸÑŸâ Ÿàÿ£ŸÉÿ®ÿ± Ÿàÿ£ŸÇÿ±ÿ® ŸÑÿ£ÿ≠ŸÑÿßŸÖŸÉ üå∏
ÿ¥ÿ¨ŸÜÿå ŸÉŸÑ ŸäŸàŸÖ ŸÖÿπŸÉ ÿ®ÿ≠ÿ≥ ÿ•ŸÜŸä ÿ®ÿßŸÑÿØŸÜŸäÿß ÿßŸÑÿµÿ≠‚Ä¶
ÿ•ŸÜÿ™Ÿê ÿßŸÑÿ≠Ÿäÿßÿ©ÿå Ÿàÿ•ŸÜÿ™Ÿê ÿßŸÑÿ≠ÿ®ÿå ŸÖÿ¥ ÿ®ÿ≥ ÿ®ŸäŸàŸÖ ŸÖŸäŸÑÿßÿØŸÉÿå ÿ®ŸÉŸÑ ÿ£ŸäÿßŸÖŸÉ.

ÿ®ÿ™ŸÖŸÜÿßŸÑŸÉ ÿ£ŸäÿßŸÖ ŸÖŸÑŸäÿßŸÜÿ© ÿ≠ÿ® Ÿàÿ£ŸÖÿßŸÜŸäÿå Ÿàÿ≠ÿØÿ© Ÿàÿ≠ÿØÿ© ÿ™ÿ™ÿ≠ŸÇŸÇ ŸÇÿØÿßŸÖ ÿπŸäŸàŸÜŸÉ.
Ÿàÿ£ŸÜÿßÿü
ÿ£ŸÜÿß ÿ®ÿØŸä ÿ£ŸÉŸàŸÜ ŸÖÿπŸÉ ÿ®ŸÉŸÑ ŸÑÿ≠ÿ∏ÿ©‚Ä¶
ÿ™ÿπÿ®ÿßŸÜÿ©ÿü ÿ®ŸÉŸàŸÜ ÿØŸÉÿ™Ÿàÿ±ŸÉ.
ŸÖÿ±Ÿäÿ∂ÿ©ÿü ÿ®ŸÉŸàŸÜ ÿπŸÑÿßÿ¨ŸÉ .
ŸÑÿ£ŸÜŸá Ÿáÿßÿ∂ ÿßŸÑÿ¥ÿπŸàÿ± ÿßŸÑÿ≠ŸÇŸäŸÇŸä ŸÉŸÑ ŸÖÿß ÿ£ÿ≠ŸÉŸä ŸÖÿπŸÉ ŸàŸÉŸÑ ŸÖÿß ÿ£ŸÅŸÉÿ± ŸÅŸäŸÉ.

ÿßŸÑÿ≠ÿ® ŸÖÿ¥ ÿ•ÿ¥Ÿä ÿ≥ŸáŸÑÿå ŸàŸÖÿ¥ ŸÑÿ≠ÿ∏ÿ© ÿπÿßÿ®ÿ±ÿ©.
ŸàÿßŸÑŸÑŸä ÿ®ŸäŸÜŸä Ÿàÿ®ŸäŸÜŸÉ ŸÖÿ¥ ŸÖÿ¨ÿ±ÿØ ÿ≠ÿ®‚Ä¶
ŸáŸà ŸÖÿ±ÿ≠ŸÑÿ© ÿ£ÿπŸÑŸâÿå ÿ£ÿπŸÖŸÇÿå Ÿàÿ£ÿµÿØŸÇ üíû

ŸÉŸÑ ÿ≥ŸÜÿ© Ÿàÿ•ŸÜÿ™Ÿê ÿ®ÿÆŸäÿ± Ÿäÿß ÿ£ÿ¨ŸÖŸÑ ÿµÿØŸÅÿ© ÿ®ÿ≠Ÿäÿßÿ™Ÿä üéÇ‚ú®
‚Äî Obai
`;

    // (5) Music (optional)
    // base64 data URL OR local filename (same folder)
    const MUSIC_SOURCE = "yamalayaly.mp3"; // e.g. "yamalayaly.mp3" or "" to disable

    // (6) Reveal pacing (readable)
    const ENABLE_ENVELOPE = false; // set to false if you want to remove the envelope for now
    const LINE_DELAY_MIN = 700;   // ms (slower = bigger)
    const LINE_DELAY_MAX = 1000;   // ms
    const EXTRA_PAUSE_EMPTY_LINE = 1200; // extra pause when the line is empty

    /************************************************************
     * ===================== END EDIT HERE =======================
     ************************************************************/

    /* Unlock date */
    const TARGET = { d: 11, m: 1, y: 2005 };

    /* Elements */
    const card = document.getElementById("card");
    const cardInner = document.getElementById("cardInner");
    const titleLineEl = document.getElementById("titleLine");
    const subtitleEl = document.getElementById("subtitle");

    const dateInput = document.getElementById("dateInput");
    const unlockBtn = document.getElementById("unlockBtn");
    const hint = document.getElementById("hint");
    const unlockBox = document.getElementById("unlockBox");
    const reveal = document.getElementById("reveal");

    const envelopeWrap = document.getElementById("envelopeWrap");
    const envelope = document.getElementById("envelope");
    const revealContent = document.getElementById("revealContent");

    const photoBox = document.getElementById("photoBox");
    const photoPlaceholder = document.getElementById("photoPlaceholder");
    const arabicMsg = document.getElementById("arabicMsg");
    const musicBtn = document.getElementById("musicBtn");
    const motionBtn = document.getElementById("motionBtn");
    const saveBtn = document.getElementById("saveBtn");

    // BERRY FEATURE START
    const berryBtn = document.getElementById("berryBtn");
    const berryOverlay = document.getElementById("berryOverlay");
    const berryClose = document.getElementById("berryClose");
    // BERRY FEATURE END

    const bgCanvas = document.getElementById("bgCanvas");
    const burstCanvas = document.getElementById("burstCanvas");

    /* Apply title */
    titleLineEl.textContent = OPTIONAL_TITLE_LINE;

    /* Apply photo crop variables (CSS var + direct iOS fallback) */
    function applyPhotoFocus(){
      const x = Math.max(0, Math.min(100, Number(PHOTO_FOCUS_X)));
      const y = Math.max(0, Math.min(100, Number(PHOTO_FOCUS_Y)));

      document.documentElement.style.setProperty("--photo-x", `${x}%`);
      document.documentElement.style.setProperty("--photo-y", `${y}%`);

      if (photoBox){
        photoBox.style.backgroundPosition = `${x}% ${y}%`;
      }
    }
    applyPhotoFocus();

    // We'll reveal Arabic message line-by-line after the envelope opens
    const FULL_ARABIC = (MY_ARABIC_MESSAGE || "").trim();
    arabicMsg.textContent = "";

    /* Load photo (iOS-reliable: use background-image on the photo container) */
    if (SHGAN_PHOTO && SHGAN_PHOTO.trim()) {
      const src = SHGAN_PHOTO.trim();
      if (photoBox){
        photoBox.style.backgroundImage = `url("${src.replace(/\"/g,'\\\"')}")`;
        photoBox.dataset.hasPhoto = "1";
      }
      photoPlaceholder.style.display = "none";
      requestAnimationFrame(() => applyPhotoFocus());
    }

    /* Audio */
    let audioEl = null;
    if (MUSIC_SOURCE && MUSIC_SOURCE.trim()) {
      audioEl = new Audio(MUSIC_SOURCE.trim());
      audioEl.loop = true;
      audioEl.preload = "auto";
    } else {
      musicBtn.textContent = "Play music üé∂ (add later)";
    }

    // Secret toast (for heart easter egg)
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.id = "toast";
    document.body.appendChild(toast);

    function setHint(text, good=false) {
      hint.textContent = text;
      hint.style.color = good ? "rgba(37, 120, 76, .95)" : "rgba(109, 90, 103,.95)";
    }

    function gentleShake(el) {
      el.classList.remove("shake");
      void el.offsetWidth;
      el.classList.add("shake");
      setTimeout(() => el.classList.remove("shake"), 450);
    }

    function revealArabicLineByLine(text){
      const lines = (text || "").split(/\n/);
      let i = 0;

      arabicMsg.innerHTML = "";
      if (arabicMsg._revealTimer) {
        clearTimeout(arabicMsg._revealTimer);
        arabicMsg._revealTimer = null;
      }

      const cursor = document.createElement("span");
      cursor.className = "typingCursor";
      cursor.setAttribute("aria-hidden", "true");
      arabicMsg.appendChild(cursor);

      const extraPauseForLine = (line) => {
        const t = (line || "").trim();
        if (!t) return EXTRA_PAUSE_EMPTY_LINE;
        if (/[\.\!\?ÿü‚Ä¶]$/.test(t)) return 260;
        if (/[,:ÿåÿõ]$/.test(t)) return 160;
        return 0;
      };

      const step = () => {
        if (i >= lines.length) {
          cursor.remove();
          arabicMsg._revealTimer = null;
          return;
        }

        const lineText = lines[i];

        if (!lineText.trim()) {
          const gap = document.createElement("div");
          gap.style.height = "10px";
          gap.style.opacity = "0";
          arabicMsg.insertBefore(gap, cursor);

          const delay = (LINE_DELAY_MIN + Math.floor(Math.random() * Math.max(1, (LINE_DELAY_MAX - LINE_DELAY_MIN) + 1)))
                        + extraPauseForLine(lineText);
          i++;
          arabicMsg._revealTimer = setTimeout(step, delay);
          return;
        }

        const lineEl = document.createElement("span");
        lineEl.className = "arabicLine";
        lineEl.textContent = lineText;
        arabicMsg.insertBefore(lineEl, cursor);

        void lineEl.offsetWidth;
        lineEl.classList.add("show");

        const delay = (LINE_DELAY_MIN + Math.floor(Math.random() * Math.max(1, (LINE_DELAY_MAX - LINE_DELAY_MIN) + 1)))
                      + extraPauseForLine(lineText);
        i++;
        arabicMsg._revealTimer = setTimeout(step, delay);
      };

      step();
    }

    function showToast(text){
      toast.textContent = text;
      toast.classList.remove("show");
      void toast.offsetWidth;
      toast.classList.add("show");
    }

    /* Date parsing */
    function parseDate(input) {
      if (!input) return null;
      const s = input.trim();

      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m) return { y:+m[1], m:+m[2], d:+m[3] };

      m = s.match(/^(\d{2})[\/\-.](\d{2})[\/\-.](\d{4})$/);
      if (m) return { d:+m[1], m:+m[2], y:+m[3] };

      const digits = s.replace(/\D/g, "");
      if (digits.length === 8) {
        return { d:+digits.slice(0,2), m:+digits.slice(2,4), y:+digits.slice(4) };
      }

      return null;
    }

    function isCorrect(p){
      return !!p && p.d===TARGET.d && p.m===TARGET.m && p.y===TARGET.y;
    }

    /* Auto-format digits: 11012005 -> 11/01/2005 */
    dateInput.addEventListener("input", () => {
      const raw = dateInput.value;
      if (/^\d{4}-\d{2}-\d{2}$/.test(raw.trim())) return;

      const digits = raw.replace(/\D/g, "").slice(0,8);
      if (!digits) return;

      let formatted = digits;
      if (digits.length >= 3) formatted = digits.slice(0,2) + "/" + digits.slice(2);
      if (digits.length >= 5) formatted = digits.slice(0,2) + "/" + digits.slice(2,4) + "/" + digits.slice(4);

      const compact = raw.replace(/\s/g,"");
      if (compact.length <= digits.length + 2) dateInput.value = formatted;
    });

    function showReveal(){
      setHint("Unlocked! ‚ú®üíó", true);

      unlockBox.style.opacity = "0";
      unlockBox.style.transform = "translateY(-6px)";
      unlockBox.style.transition = "opacity .45s ease, transform .45s ease";

      setTimeout(() => {
        unlockBox.style.display = "none";
        reveal.classList.add("show");

        envelopeOpened = false;
        if (revealContent) revealContent.classList.remove("show");
        if (envelope) envelope.classList.remove("open");
        if (envelopeWrap) envelopeWrap.style.display = "";
        arabicMsg.textContent = "";

        if (!ENABLE_ENVELOPE){
          if (envelopeWrap) envelopeWrap.style.display = "none";

          setTimeout(() => {
            if (revealContent) revealContent.classList.add("show");
          }, 260);

          setTimeout(() => {
            revealArabicLineByLine(FULL_ARABIC);
          }, 620);
        }

        burstCinematic();
        constellationOnce();
      }, 480);

      if (audioEl) {
        audioEl.play().then(() => {
          musicBtn.textContent = "Pause music ‚è∏Ô∏è";
        }).catch(() => {
          musicBtn.textContent = "Play music üé∂";
        });
      }
    }

    function failUnlock(){
      setHint("Almost! Try your special date ü•∫üíû", false);
      gentleShake(dateInput);
    }

    function tryUnlock(){
      const p = parseDate(dateInput.value);
      if (isCorrect(p)) showReveal();
      else failUnlock();
    }

    unlockBtn.addEventListener("click", tryUnlock);
    dateInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") tryUnlock();
    });

    setHint("üí° Enter my soulmate birthday date to unlock");

    /* Music button */
    musicBtn.addEventListener("click", async () => {
      if (!audioEl) {
        gentleShake(musicBtn);
        return;
      }
      try{
        if (audioEl.paused){
          await audioEl.play();
          musicBtn.textContent = "Pause music ‚è∏Ô∏è";
        } else {
          audioEl.pause();
          musicBtn.textContent = "Play music üé∂";
        }
      }catch{
        setHint("Tap again ‚Äî some phones need a second tap üíû", false);
      }
    });

    /* Save memory as .txt */
    saveBtn.addEventListener("click", () => {
      const content =
`A love note for Shgan üíó
====================

${(MY_ARABIC_MESSAGE||"").trim()}

--------------------
(saved as a memory ‚ú®)
`;
      const blob = new Blob([content], { type:"text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "memory-for-shgan.txt";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setHint("Saved üíå", true);
    });

    /************************************************************
     * 3D INTERACTION: Touch tilt + optional device orientation
     ************************************************************/
    const state = {
      targetRX: 0, targetRY: 0,
      rx: 0, ry: 0,
      targetLX: 50, targetLY: 30,
      lx: 50, ly: 30,
      targetSX: 0, targetSY: 18,
      sx: 0, sy: 18,
      usingDevice: false
    };

    function spring(current, target, stiffness=0.12){
      return current + (target - current) * stiffness;
    }
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    function pointerToTilt(clientX, clientY){
      const rect = card.getBoundingClientRect();
      const px = (clientX - (rect.left + rect.width/2)) / (rect.width/2);
      const py = (clientY - (rect.top + rect.height/2)) / (rect.height/2);

      state.targetRY = clamp(px * 10, -10, 10);
      state.targetRX = clamp(-py * 8, -8, 8);

      state.targetLX = clamp((px*50 + 50), 8, 92);
      state.targetLY = clamp((py*40 + 30), 8, 92);

      state.targetSX = clamp(px * 10, -10, 10);
      state.targetSY = clamp(18 + py * 10, 8, 30);
    }

    card.addEventListener("touchmove", (e) => {
      if (state.usingDevice) return;
      const t = e.touches[0];
      if (!t) return;
      pointerToTilt(t.clientX, t.clientY);
    }, { passive:true });

    function resetTilt(){
      if (state.usingDevice) return;
      state.targetRX = 0;
      state.targetRY = 0;
      state.targetLX = 50;
      state.targetLY = 30;
      state.targetSX = 0;
      state.targetSY = 18;
    }
    card.addEventListener("touchend", resetTilt, { passive:true });
    card.addEventListener("touchcancel", resetTilt, { passive:true });

    function handleOrientation(ev){
      const gamma = ev.gamma ?? 0;
      const beta  = ev.beta ?? 0;
      const g = clamp(gamma / 35, -1, 1);
      const b = clamp(beta  / 35, -1, 1);

      state.usingDevice = true;

      state.targetRY = clamp(g * 10, -10, 10);
      state.targetRX = clamp(-b * 8, -8, 8);

      state.targetLX = clamp((g*40 + 50), 8, 92);
      state.targetLY = clamp((b*35 + 35), 8, 92);

      state.targetSX = clamp(g * 10, -10, 10);
      state.targetSY = clamp(18 + b * 10, 8, 30);
    }

    let orientationEnabled = false;
    function enableOrientation(){
      if (orientationEnabled) return;
      window.addEventListener("deviceorientation", handleOrientation, true);
      orientationEnabled = true;
      setHint("3D Motion enabled ‚ú®", true);
    }

    (function setupMotionButton(){
      if (!motionBtn) return;

      const hasDeviceOrientation = "DeviceOrientationEvent" in window;
      if (!hasDeviceOrientation){
        motionBtn.style.display = "none";
        return;
      }

      motionBtn.addEventListener("click", async () => {
        try{
          const DOE = window.DeviceOrientationEvent;
          if (DOE && typeof DOE.requestPermission === "function"){
            const res = await DOE.requestPermission();
            if (res === "granted"){
              enableOrientation();
            } else {
              setHint("No worries üíû If you allow Motion access, the card will move in 3D.", false);
              gentleShake(motionBtn);
            }
            return;
          }
          enableOrientation();
        }catch(e){
          setHint("Motion not available on this device üíû", false);
          gentleShake(motionBtn);
        }
      }, { passive:true });
    })();

    let t0 = performance.now();
    function tick(now){
      t0 = now;

      const float = Math.sin(now/900) * 6;
      document.documentElement.style.setProperty("--floatY", `${float}px`);

      state.rx = spring(state.rx, state.targetRX, 0.10);
      state.ry = spring(state.ry, state.targetRY, 0.10);

      state.lx = spring(state.lx, state.targetLX, 0.08);
      state.ly = spring(state.ly, state.targetLY, 0.08);

      state.sx = spring(state.sx, state.targetSX, 0.10);
      state.sy = spring(state.sy, state.targetSY, 0.10);

      document.documentElement.style.setProperty("--rx", `${state.rx}deg`);
      document.documentElement.style.setProperty("--ry", `${state.ry}deg`);
      document.documentElement.style.setProperty("--tz", `0px`);

      document.documentElement.style.setProperty("--lx", `${state.lx}%`);
      document.documentElement.style.setProperty("--ly", `${state.ly}%`);

      document.documentElement.style.setProperty("--sx", `${state.sx}px`);
      document.documentElement.style.setProperty("--sy", `${state.sy}px`);

      document.documentElement.style.setProperty("--bx", `${state.ry * 2}px`);
      document.documentElement.style.setProperty("--by", `${state.rx * -2}px`);

      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    /************************************************************
     * Canvas Background
     ************************************************************/
    const bgCtx = bgCanvas.getContext("2d", { alpha:true });
    const burstCtx = burstCanvas.getContext("2d", { alpha:true });

    function resizeCanvas(c){
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      c.width = Math.floor(innerWidth * dpr);
      c.height = Math.floor(innerHeight * dpr);
      c.style.width = innerWidth + "px";
      c.style.height = innerHeight + "px";
      return dpr;
    }

    let bgDpr = resizeCanvas(bgCanvas);
    let burstDpr = resizeCanvas(burstCanvas);

    window.addEventListener("resize", () => {
      bgDpr = resizeCanvas(bgCanvas);
      burstDpr = resizeCanvas(burstCanvas);
      initBG();
    });

    function rand(a,b){ return Math.random()*(b-a)+a; }

    const layers = [
      { count: 22, rmin: 18, rmax: 66, alpha: [0.07,0.18], speed: 0.09, hue: [332,356], depth: 0.30 },
      { count: 18, rmin: 14, rmax: 52, alpha: [0.06,0.15], speed: 0.16, hue: [328,352], depth: 0.55 },
      { count: 12, rmin: 10, rmax: 38, alpha: [0.05,0.12], speed: 0.24, hue: [322,348], depth: 0.88 },
    ];

    let bokeh = [];
    let stars = [];

    function initBG(){
      bokeh = [];
      stars = [];

      for (const L of layers){
        for (let i=0;i<L.count;i++){
          bokeh.push({
            x: rand(0, innerWidth),
            y: rand(0, innerHeight),
            r: rand(L.rmin, L.rmax),
            a: rand(L.alpha[0], L.alpha[1]),
            vx: rand(-L.speed, L.speed),
            vy: rand(-L.speed, L.speed),
            hue: rand(L.hue[0], L.hue[1]),
            p: rand(0, Math.PI*2),
            depth: L.depth
          });
        }
      }

      for (let i=0;i<90;i++){
        stars.push({
          x: rand(0, innerWidth),
          y: rand(0, innerHeight),
          s: rand(0.8, 1.7),
          a: 0,
          t: rand(0, Math.PI*2),
          vx: rand(-0.12, 0.12),
          vy: rand(-0.12, 0.12),
          depth: rand(0.6, 1.0)
        });
      }
    }
    initBG();

    // CONSTELLATION SHGAN START
    const CONSTELLATION_KEY = "constellation_shgan_once_v1";
    const constellation = {
      active: false,
      phase: "idle", // gather | hold | disperse
      t0: 0,
      durGather: 1400,
      durHold: 2000,
      durDisperse: 1000,
      map: [], // [{i, ox, oy, ovx, ovy, tx, ty}]
      targets: [],
      locked: null, // Set of star indices locked into the word
      threshold: 94,
      boostAlpha: 0.38,
      ready: false,
    };

    function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }
    function easeInOutCubic(t){ return t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t + 2, 3)/2; }
    function lerp(a,b,t){ return a + (b-a)*t; }

    // Build a tiny dot-matrix for SHGAN in normalized (0..1) coordinates.
    // Light + iPhone-friendly: ~60‚Äì90 points.
    function buildSHGANTargets(){
      // 7x7-ish grids per letter, 1 = point
      const S = [
        "1111110",
        "1000000",
        "1111100",
        "0000110",
        "0000010",
        "0111110",
      ];
      const H = [
        "1000010",
        "1000010",
        "1111110",
        "1000010",
        "1000010",
        "1000010",
      ];
      const G = [
        "0111110",
        "1000000",
        "1001110",
        "1000010",
        "1000010",
        "0111110",
      ];
      const A = [
        "0011100",
        "0100010",
        "0100010",
        "0111110",
        "0100010",
        "0100010",
      ];
      const N = [
        "1000010",
        "1100010",
        "1010010",
        "1001010",
        "1000110",
        "1000010",
      ];

      const letters = [S,H,G,A,N];
      const w = 7;
      const h = 6;
      const gap = 2; // columns between letters

      // Compose into one grid
      const totalW = letters.length*w + (letters.length-1)*gap;
      const pts = [];

      let xOff = 0;
      for (let li=0; li<letters.length; li++){
        const L = letters[li];
        for (let y=0; y<h; y++){
          const row = L[y];
          for (let x=0; x<w; x++){
            if (row[x] === "1"){
              pts.push({
                gx: xOff + x,
                gy: y
              });
            }
          }
        }
        xOff += w + gap;
      }

      // Normalize: leave margins, slightly above center
      // Map grid to normalized canvas coordinates
      const targets = pts.map(p => {
        const nx = (p.gx + 0.5) / totalW;
        const ny = (p.gy + 0.5) / h;
        return { nx, ny };
      });

      return targets;
    }

    function computeTargetPixels(){
      // Layout: centered horizontally, slightly upper-mid
      const padX = 0.10;
      const padY = 0.18;
      const boxW = 1 - padX*2;
      const boxH = 0.20; // tight height for word

      // Scale based on shortest side, but keep within box
      const targets = buildSHGANTargets();
      constellation.targets = targets.map(t => {
        const x = innerWidth  * (padX + t.nx * boxW);
        const y = innerHeight * (padY + t.ny * boxH);
        return { x, y };
      });
    }

    function constellationOnce(){
      try{
        if (sessionStorage.getItem(CONSTELLATION_KEY) === "1") return;
      }catch{}

      if (!stars || stars.length < 12) return;

      // mark once per session
      try{ sessionStorage.setItem(CONSTELLATION_KEY, "1"); }catch{}
      document.body.classList.add("constellationOn");

      computeTargetPixels();

      // Pick subset of stars to map to targets
      const m = Math.min(stars.length, constellation.targets.length);
      if (m < 18) return;

      // Create a stable selection of stars: take the brightest-like (bigger s) first
      const idx = stars
        .map((s, i) => ({ i, s: s.s }))
        .sort((a,b) => b.s - a.s)
        .slice(0, m)
        .map(o => o.i);

      constellation.map = [];
      constellation.locked = new Set();
      for (let k=0; k<m; k++){
        const i = idx[k];
        const st = stars[i];
        const t = constellation.targets[k];
        constellation.map.push({
          i,
          ox: st.x, oy: st.y,
          ovx: st.vx, ovy: st.vy,
          tx: t.x, ty: t.y,
        });
        constellation.locked.add(i);
      }

      constellation.active = true;
      constellation.phase = "gather";
      constellation.t0 = performance.now();
      constellation.durGather = Math.floor(rand(1200, 1600));
      constellation.durHold = 2000;
      constellation.durDisperse = 1000;
      constellation.threshold = Math.max(78, Math.min(110, innerWidth * 0.11));
      constellation.ready = true;
    }

    function constellationUpdate(now){
      if (!constellation.active || !constellation.ready) return;

      const t = now - constellation.t0;
      const g = constellation.durGather;
      const h = constellation.durHold;
      const d = constellation.durDisperse;

      if (constellation.phase === "gather"){
        const p = clamp(t / g, 0, 1);
        const e = easeOutCubic(p);
        for (const m of constellation.map){
          const st = stars[m.i];
          st.x = lerp(m.ox, m.tx, e);
          st.y = lerp(m.oy, m.ty, e);
          st.vx = 0; st.vy = 0;
          st.a = Math.max(st.a, 0.22 + e * constellation.boostAlpha);
        }
        if (p >= 1){
          constellation.phase = "hold";
          constellation.t0 = now;
        }
        return;
      }

      if (constellation.phase === "hold"){
        // gentle twinkle without moving
        for (const m of constellation.map){
          const st = stars[m.i];
          st.x = m.tx;
          st.y = m.ty;
          st.vx = 0; st.vy = 0;
          st.t += 0.02;
          st.a = 0.46 + (Math.sin(st.t) + 1) * 0.16;
        }
        if (t >= h){
          constellation.phase = "disperse";
          constellation.t0 = now;
        }
        return;
      }

      if (constellation.phase === "disperse"){
        const p = clamp(t / d, 0, 1);
        const e = easeInOutCubic(p);
        for (const m of constellation.map){
          const st = stars[m.i];
          st.x = lerp(m.tx, m.ox, e);
          st.y = lerp(m.ty, m.oy, e);
          st.vx = 0; st.vy = 0;
          st.a = Math.max(st.a, 0.34 + e * 0.46);
        }
        if (p >= 1){
          // restore normal motion smoothly
          for (const m of constellation.map){
            const st = stars[m.i];
            st.x = m.ox;
            st.y = m.oy;
            st.vx = m.ovx;
            st.vy = m.ovy;
          }
          document.body.classList.remove("constellationOn");
          constellation.active = false;
          constellation.phase = "idle";
          constellation.map = [];
          constellation.locked = null;
          constellation.ready = false;
        }
      }
    }

    function drawConstellationLines(){
      if (!constellation.active || !constellation.map.length) return;
      const pts = constellation.map.map(m => stars[m.i]);
      const th = constellation.threshold;

      bgCtx.save();
      bgCtx.lineWidth = 1;
      bgCtx.strokeStyle = "rgba(255,255,255,0.55)";
      bgCtx.shadowColor = "rgba(255,255,255,.18)";
      bgCtx.shadowBlur = 8;

      // ‚úÖ Performance fix: avoid O(n^2) ‚Äî only check the next few points
      const MAX_NEIGHBORS = 10;

      for (let i = 0; i < pts.length; i++){
        const a = pts[i];
        for (let j = i + 1; j < pts.length && j < i + 1 + MAX_NEIGHBORS; j++){
          const b = pts[j];
          const dx = a.x - b.x;
          const dy = a.y - b.y;
          const dist = Math.hypot(dx, dy);

          if (dist < th){
            const fade = 1 - (dist / th);
            bgCtx.globalAlpha = 0.04 + fade * 0.14; // ÿÆÿ∑Ÿàÿ∑ ÿÆŸÅŸäŸÅÿ© ŸÖÿ¥ ‚ÄúÿÆÿ∑‚Äù
            bgCtx.beginPath();
            bgCtx.moveTo(a.x, a.y);
            bgCtx.lineTo(b.x, b.y);
            bgCtx.stroke();
          }
        }
      }

      bgCtx.restore();
    }

    // Keep constellation scaled on resize
    window.addEventListener("resize", () => {
      if (constellation.active){
        computeTargetPixels();
        // update targets for current mapping index (keep order)
        const m = Math.min(constellation.map.length, constellation.targets.length);
        for (let k=0; k<m; k++){
          const t = constellation.targets[k];
          constellation.map[k].tx = t.x;
          constellation.map[k].ty = t.y;
        }
      }
    });
    // CONSTELLATION SHGAN END

function bgLoop(now){
  bgCtx.setTransform(bgDpr,0,0,bgDpr,0,0);
  bgCtx.clearRect(0,0,innerWidth,innerHeight);

  const inConstellation = !!constellation.active;
  // Make SHGAN obvious: dim the normal sky during constellation
  const skyDim  = inConstellation ? 0.18 : 1.0;  // dims regular stars
  const bokehDim = inConstellation ? 0.25 : 1.0; // dims bokeh blobs

  // Update constellation positions (if active)
  constellationUpdate(now);

  const px = state.ry / 10;
  const py = state.rx / 8;

  // Bokeh blobs (freeze movement during constellation so the word is clearer)
  for (const p of bokeh){
    if (!inConstellation){
      p.x += p.vx;
      p.y += p.vy;
    }
    p.p += 0.012;

    if (p.x < -100) p.x = innerWidth + 100;
    if (p.x > innerWidth + 100) p.x = -100;
    if (p.y < -100) p.y = innerHeight + 100;
    if (p.y > innerHeight + 100) p.y = -100;

    const ox = px * 26 * p.depth;
    const oy = py * 26 * p.depth;

    const alpha = (p.a + Math.sin(p.p)*0.02) * bokehDim;
    const g = bgCtx.createRadialGradient(p.x+ox, p.y+oy, 0, p.x+ox, p.y+oy, p.r);
    g.addColorStop(0, `hsla(${p.hue}, 95%, 76%, ${alpha})`);
    g.addColorStop(1, `hsla(${p.hue}, 95%, 76%, 0)`);
    bgCtx.fillStyle = g;
    bgCtx.beginPath();
    bgCtx.arc(p.x+ox, p.y+oy, p.r, 0, Math.PI*2);
    bgCtx.fill();
  }

  // Constellation lines on top of bokeh
  if (inConstellation) drawConstellationLines();

  // Stars
  for (let si = 0; si < stars.length; si++){
    const s = stars[si];
    const isLocked = !!(constellation.active && constellation.locked && constellation.locked.has(si));

    // Normal stars keep drifting. Locked stars are positioned by constellationUpdate().
    if (!isLocked){
      s.t += 0.03;
      s.x += s.vx;
      s.y += s.vy;

      if (s.x < -30) s.x = innerWidth + 30;
      if (s.x > innerWidth + 30) s.x = -30;
      if (s.y < -30) s.y = innerHeight + 30;
      if (s.y > innerHeight + 30) s.y = -30;

      s.a = 0.18 + (Math.sin(s.t)+1)*0.12;
    } else {
      // Keep a tiny twinkle without moving or overwriting constellation alpha
      s.t += 0.02;
      s.a = Math.max(s.a || 0, 0.26 + (Math.sin(s.t)+1)*0.10);
    }

    const ox = isLocked ? 0 : (px * 34 * s.depth);
    const oy = isLocked ? 0 : (py * 34 * s.depth);

    bgCtx.save();
    const baseA = (s.a || 0.22) * (isLocked ? 1.0 : skyDim);
    bgCtx.globalAlpha = baseA;

    // Locked stars (SHGAN) should be SUPER obvious + still premium
    bgCtx.fillStyle = isLocked ? "rgba(255,255,255,1)" : "rgba(255,255,255,1)";
    if (isLocked){
      bgCtx.shadowColor = "rgba(255,95,165,.95)";
      bgCtx.shadowBlur = 18;
    } else {
      bgCtx.shadowColor = "rgba(255,255,255,.55)";
      bgCtx.shadowBlur = 10;
    }

    bgCtx.translate(s.x+ox, s.y+oy);
    bgCtx.rotate(s.t * 0.25);

    const kScale = isLocked ? 2.75 : 1.0;

    bgCtx.beginPath();
    bgCtx.moveTo(0, -6*s.s*kScale);
    bgCtx.lineTo(1.6*s.s*kScale, -1.6*s.s*kScale);
    bgCtx.lineTo(6*s.s*kScale, 0);
    bgCtx.lineTo(1.6*s.s*kScale, 1.6*s.s*kScale);
    bgCtx.lineTo(0, 6*s.s*kScale);
    bgCtx.lineTo(-1.6*s.s*kScale, 1.6*s.s*kScale);
    bgCtx.lineTo(-6*s.s*kScale, 0);
    bgCtx.lineTo(-1.6*s.s*kScale, -1.6*s.s*kScale);
    bgCtx.closePath();
    bgCtx.fill();
    bgCtx.restore();
  }

  requestAnimationFrame(bgLoop);
}
requestAnimationFrame(bgLoop);

    /************************************************************
     * Cinematic Burst + helper bursts
     ************************************************************/
    let burstParts = [];

    function burstCinematic(){
      burstCanvas.classList.add("show");
      burstParts = [];

      const cx = innerWidth * 0.5;
      const cy = innerHeight * 0.40;

      const N = 120;
      for (let i=0;i<N;i++){
        const a = rand(0, Math.PI*2);
        const sp = rand(1.8, 6.2);
        const isHeart = Math.random() < 0.28;

        burstParts.push({
          x: cx, y: cy,
          vx: Math.cos(a)*sp,
          vy: Math.sin(a)*sp - rand(0.8, 1.8),
          r: rand(1.1, 2.8),
          life: rand(52, 95),
          hue: rand(330, 355),
          rot: rand(0, Math.PI*2),
          vr: rand(-0.22, 0.22),
          heart: isHeart
        });
      }

      const start = performance.now();
      function step(now){
        const t = now - start;
        burstCtx.setTransform(burstDpr,0,0,burstDpr,0,0);
        burstCtx.clearRect(0,0,innerWidth,innerHeight);

        const flash = Math.max(0, 1 - t/420);
        if (flash > 0){
          burstCtx.globalAlpha = flash * 0.24;
          const g = burstCtx.createRadialGradient(cx, cy, 0, cx, cy, 380);
          g.addColorStop(0, "rgba(255,255,255,1)");
          g.addColorStop(1, "rgba(255,255,255,0)");
          burstCtx.fillStyle = g;
          burstCtx.beginPath();
          burstCtx.arc(cx, cy, 380, 0, Math.PI*2);
          burstCtx.fill();
        }

        burstCtx.globalAlpha = 1;

        for (const p of burstParts){
          if (p.life <= 0) continue;
          p.life -= 1;

          p.vy += 0.055;
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vr;

          const alpha = Math.min(1, p.life/95);

          burstCtx.save();
          burstCtx.globalAlpha = alpha;
          burstCtx.translate(p.x, p.y);
          burstCtx.rotate(p.rot);

          burstCtx.shadowColor = "rgba(255,79,147,.55)";
          burstCtx.shadowBlur = 18;

          if (p.heart){
            burstCtx.fillStyle = `hsla(${p.hue}, 95%, 74%, 1)`;
            burstCtx.beginPath();
            const s = 3.4 + p.r;
            burstCtx.moveTo(0, s*1.2);
            burstCtx.bezierCurveTo(-s*1.4, s*0.2, -s*1.2, -s*1.1, 0, -s*0.25);
            burstCtx.bezierCurveTo(s*1.2, -s*1.1, s*1.4, s*0.2, 0, s*1.2);
            burstCtx.closePath();
            burstCtx.fill();
          } else {
            burstCtx.fillStyle = "rgba(255,255,255,1)";
            const k = p.r * 6;
            burstCtx.beginPath();
            burstCtx.moveTo(0, -k);
            burstCtx.lineTo(k*0.28, -k*0.28);
            burstCtx.lineTo(k, 0);
            burstCtx.lineTo(k*0.28, k*0.28);
            burstCtx.lineTo(0, k);
            burstCtx.lineTo(-k*0.28, k*0.28);
            burstCtx.lineTo(-k, 0);
            burstCtx.lineTo(-k*0.28, -k*0.28);
            burstCtx.closePath();
            burstCtx.fill();
          }

          burstCtx.restore();
        }

        const alive = burstParts.some(p => p.life > 0);
        if (alive && t < 2200) requestAnimationFrame(step);
        else setTimeout(() => burstCanvas.classList.remove("show"), 200);
      }

      requestAnimationFrame(step);
    }

    function burstSmall(x, y){
      burstCanvas.classList.add("show");
      const parts = [];
      const N = 46;

      for (let i=0;i<N;i++){
        const a = rand(0, Math.PI*2);
        const sp = rand(1.4, 4.0);
        const isHeart = Math.random() < 0.34;
        parts.push({
          x, y,
          vx: Math.cos(a)*sp,
          vy: Math.sin(a)*sp - rand(0.6, 1.4),
          r: rand(0.9, 2.2),
          life: rand(26, 48),
          hue: rand(332, 356),
          rot: rand(0, Math.PI*2),
          vr: rand(-0.28, 0.28),
          heart: isHeart
        });
      }

      const start = performance.now();
      function step(now){
        const t = now - start;
        burstCtx.setTransform(burstDpr,0,0,burstDpr,0,0);
        burstCtx.clearRect(0,0,innerWidth,innerHeight);

        for (const p of parts){
          if (p.life <= 0) continue;
          p.life -= 1;
          p.vy += 0.06;
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vr;

          const alpha = Math.min(1, p.life/48);
          burstCtx.save();
          burstCtx.globalAlpha = alpha;
          burstCtx.translate(p.x, p.y);
          burstCtx.rotate(p.rot);
          burstCtx.shadowColor = "rgba(255,79,147,.45)";
          burstCtx.shadowBlur = 14;

          if (p.heart){
            burstCtx.fillStyle = `hsla(${p.hue}, 95%, 74%, 1)`;
            burstCtx.beginPath();
            const s = 3.0 + p.r;
            burstCtx.moveTo(0, s*1.2);
            burstCtx.bezierCurveTo(-s*1.4, s*0.2, -s*1.2, -s*1.1, 0, -s*0.25);
            burstCtx.bezierCurveTo(s*1.2, -s*1.1, s*1.4, s*0.2, 0, s*1.2);
            burstCtx.closePath();
            burstCtx.fill();
          } else {
            burstCtx.fillStyle = "rgba(255,255,255,1)";
            const k = p.r * 6;
            burstCtx.beginPath();
            burstCtx.moveTo(0, -k);
            burstCtx.lineTo(k*0.28, -k*0.28);
            burstCtx.lineTo(k, 0);
            burstCtx.lineTo(k*0.28, k*0.28);
            burstCtx.lineTo(0, k);
            burstCtx.lineTo(-k*0.28, k*0.28);
            burstCtx.lineTo(-k, 0);
            burstCtx.lineTo(-k*0.28, -k*0.28);
            burstCtx.closePath();
            burstCtx.fill();
          }
          burstCtx.restore();
        }

        const alive = parts.some(p => p.life > 0);
        if (alive && t < 1200) requestAnimationFrame(step);
        else setTimeout(() => burstCanvas.classList.remove("show"), 180);
      }
      requestAnimationFrame(step);
    }

    function burstSmallAtElement(el){
      if (!el) return;
      const r = el.getBoundingClientRect();
      const cx = r.left + r.width * 0.5;
      const cy = r.top + r.height * 0.45;
      burstSmall(cx, cy);
    }

    // Envelope Unwrap
    let envelopeOpened = false;

    function openEnvelope(){
      if (!ENABLE_ENVELOPE) return;
      if (envelopeOpened) return;
      envelopeOpened = true;

      if (envelope) envelope.classList.add("open");
      burstSmallAtElement(envelope);

      setTimeout(() => {
        if (revealContent) revealContent.classList.add("show");
        revealArabicLineByLine(FULL_ARABIC);
      }, 520);
    }

    if (envelope){
      envelope.addEventListener("click", openEnvelope);
      envelope.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") openEnvelope();
      });
    }

    // Easter egg
    const heartEl = document.querySelector(".heart3D");
    let tapTimes = [];
    let secretShown = false;

    if (heartEl){
      heartEl.addEventListener("click", () => {
        if (secretShown) return;

        const now = performance.now();
        tapTimes.push(now);
        tapTimes = tapTimes.filter(t => now - t <= 4000);

        if (tapTimes.length >= 5){
          secretShown = true;
          const secret = "ÿ≥ÿ± ÿµÿ∫Ÿäÿ±‚Ä¶ ÿ•ŸÜÿ™Ÿê ÿ£ÿ¨ŸÖŸÑ ÿ¥Ÿä ÿµÿßÿ± ÿ®ÿ≠Ÿäÿßÿ™Ÿä üíó";
          showToast(secret);
          setHint(secret, true);
          burstSmallAtElement(heartEl);
        }
      }, { passive:true });
    }

    // BERRY FEATURE START
    function openBerry(){
      if (!berryOverlay) return;
      berryOverlay.classList.add("show");
      berryOverlay.setAttribute("aria-hidden", "false");

      requestAnimationFrame(() => {
        berryOverlay.classList.add("on");
      });

      try{
        const sheet = berryOverlay.querySelector(".berrySheet");
        if (sheet) burstSmallAtElement(sheet);
      }catch{}
    }

    function closeBerry(){
      if (!berryOverlay) return;
      berryOverlay.classList.remove("on");
      berryOverlay.setAttribute("aria-hidden", "true");
      setTimeout(() => {
        berryOverlay.classList.remove("show");
      }, 260);
    }

    if (berryBtn){
      berryBtn.addEventListener("click", () => openBerry(), { passive:true });
    }

    if (berryClose){
      berryClose.addEventListener("click", (e) => {
        e.stopPropagation();
        closeBerry();
      });
    }

    if (berryOverlay){
      berryOverlay.addEventListener("click", (e) => {
        if (e.target === berryOverlay) closeBerry();
      });

      const sheet = berryOverlay.querySelector(".berrySheet");
      if (sheet){
        sheet.addEventListener("click", (e) => {
          // don't close when tapping the close button itself
          if (e.target && e.target.id === "berryClose") return;
          closeBerry();
        });
      }

      // ESC to close (desktop safe)
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && berryOverlay.classList.contains("show")) closeBerry();
      });
    }
    // BERRY FEATURE END

  </script>
</body>
</html>
